version: '3.8'

# ===========================================
# AI Agent Attack Automation
# ===========================================
# Each agent has its own isolated network with dedicated victim container
# Networks are completely separated - no cross-agent communication possible

networks:
  # Isolated network for Codex agent
  net-codex:
    driver: bridge
  # Isolated network for Claude agent
  net-claude:
    driver: bridge
  # Isolated network for Gemini agent
  net-gemini:
    driver: bridge

services:
  # ===========================================
  # METRICS PROXY (LiteLLM)
  # ===========================================
  # Central proxy for token/call tracking across all agents
  metrics-proxy:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: metrics-proxy
    command: ["--config", "/app/config.yaml", "--detailed_debug"]
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LITELLM_LOG=DEBUG
      - METRICS_LOG_DIR=/app/logs
      - PYTHONPATH=/app
    volumes:
      - ./metrics/litellm_config.yaml:/app/config.yaml:ro
      - ./metrics/custom_logger.py:/app/custom_logger.py:ro
      - ./metrics/logs:/app/logs
    networks:
      - net-claude
      - net-codex
      - net-gemini
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')"]
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - "4000:4000"  # Debug access (optional)

  # ===========================================
  # CODEX ENVIRONMENT (Isolated)
  # ===========================================
  victim-codex:
    image: ${VICTIM_IMAGE:-bkimminich/juice-shop}
    container_name: victim-codex
    networks:
      - net-codex
    healthcheck:
      test: ["CMD", "/nodejs/bin/node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  agent-codex:
    build:
      context: ./agents
      dockerfile: codex/Dockerfile
    image: agent-codex:latest
    container_name: agent-codex
    networks:
      - net-codex
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=http://metrics-proxy:4000
      - AGENT_TYPE=codex
      - OUTPUT_MODE=${OUTPUT_MODE:-report}
      - OUTPUT_FORMAT_FILE=${OUTPUT_FORMAT_FILE:-}
      - VICTIM_HOST=victim-codex
      - VICTIM_PORT=${VICTIM_PORT:-3000}
    volumes:
      - ./prompts:/prompts:ro
      - ./output_formats:/output_formats:ro
    depends_on:
      victim-codex:
        condition: service_healthy
      metrics-proxy:
        condition: service_healthy

  # ===========================================
  # CLAUDE ENVIRONMENT (Isolated)
  # ===========================================
  victim-claude:
    image: ${VICTIM_IMAGE:-bkimminich/juice-shop}
    container_name: victim-claude
    networks:
      - net-claude
    healthcheck:
      test: ["CMD", "/nodejs/bin/node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  agent-claude:
    build:
      context: ./agents
      dockerfile: claude/Dockerfile
    image: agent-claude:latest
    container_name: agent-claude
    networks:
      - net-claude
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=http://metrics-proxy:4000
      - AGENT_TYPE=claude
      - OUTPUT_MODE=${OUTPUT_MODE:-report}
      - OUTPUT_FORMAT_FILE=${OUTPUT_FORMAT_FILE:-}
      - VICTIM_HOST=victim-claude
      - VICTIM_PORT=${VICTIM_PORT:-3000}
    volumes:
      - ./prompts:/prompts:ro
      - ./output_formats:/output_formats:ro
    depends_on:
      victim-claude:
        condition: service_healthy
      metrics-proxy:
        condition: service_healthy

  # ===========================================
  # GEMINI ENVIRONMENT (Isolated)
  # ===========================================
  victim-gemini:
    image: ${VICTIM_IMAGE:-bkimminich/juice-shop}
    container_name: victim-gemini
    networks:
      - net-gemini
    healthcheck:
      test: ["CMD", "/nodejs/bin/node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  agent-gemini:
    build:
      context: ./agents
      dockerfile: gemini/Dockerfile
    image: agent-gemini:latest
    container_name: agent-gemini
    networks:
      - net-gemini
    environment:
      - GEMINI_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GEMINI_BASE_URL=http://metrics-proxy:4000
      - AGENT_TYPE=gemini
      - OUTPUT_MODE=${OUTPUT_MODE:-report}
      - OUTPUT_FORMAT_FILE=${OUTPUT_FORMAT_FILE:-}
      - VICTIM_HOST=victim-gemini
      - VICTIM_PORT=${VICTIM_PORT:-3000}
    volumes:
      - ./prompts:/prompts:ro
      - ./output_formats:/output_formats:ro
    depends_on:
      victim-gemini:
        condition: service_healthy
      metrics-proxy:
        condition: service_healthy

  # ===========================================
  # BASE IMAGE BUILD (utility)
  # ===========================================
  agent-base:
    build:
      context: ./agents
      dockerfile: base/Dockerfile
    image: agent-base:latest
    container_name: agent-base-build
    command: ["echo", "Base image built successfully"]
